From d35bcd4ca5ffb8e222932967d10ed1f56aa785c5 Mon Sep 17 00:00:00 2001
From: Felipe Contreras <felipe.contreras@gmail.com>
Date: Sat, 28 Jun 2008 03:28:54 +0300
Subject: [PATCH] write-raw: initial commit.

---
 Makefile            |    1 +
 builtin-write-raw.c |   23 +++++++++++++++++++++++
 builtin.h           |    1 +
 git.c               |    1 +
 4 files changed, 26 insertions(+), 0 deletions(-)
 create mode 100644 builtin-write-raw.c

diff --git a/Makefile b/Makefile
index 2cef018..00269ab 100644
--- a/Makefile
+++ b/Makefile
@@ -560,6 +560,7 @@ BUILTIN_OBJS += builtin-update-ref.o
 BUILTIN_OBJS += builtin-upload-archive.o
 BUILTIN_OBJS += builtin-verify-pack.o
 BUILTIN_OBJS += builtin-verify-tag.o
+BUILTIN_OBJS += builtin-write-raw.o
 BUILTIN_OBJS += builtin-write-tree.o
 
 GITLIBS = $(LIB_FILE) $(XDIFF_LIB)
diff --git a/builtin-write-raw.c b/builtin-write-raw.c
new file mode 100644
index 0000000..b0a8d4c
--- /dev/null
+++ b/builtin-write-raw.c
@@ -0,0 +1,23 @@
+/*
+ * Writes a raw object
+ */
+
+#include "cache.h"
+#include "commit.h"
+
+int cmd_write_raw(int argc, const char **argv, const char *unused_prefix)
+{
+	unsigned char commit_sha1[20];
+	struct strbuf buffer;
+
+	strbuf_init(&buffer, 8192);
+
+	strbuf_read(&buffer, 0, 0);
+
+	if (!write_sha1_file(buffer.buf, buffer.len, "commit", commit_sha1)) {
+		printf("%s\n", sha1_to_hex(commit_sha1));
+		return 0;
+	}
+	else
+		return 1;
+}
diff --git a/builtin.h b/builtin.h
index f3502d3..c6ffc78 100644
--- a/builtin.h
+++ b/builtin.h
@@ -108,5 +108,6 @@ extern int cmd_write_tree(int argc, const char **argv, const char *prefix);
 extern int cmd_verify_pack(int argc, const char **argv, const char *prefix);
 extern int cmd_show_ref(int argc, const char **argv, const char *prefix);
 extern int cmd_pack_refs(int argc, const char **argv, const char *prefix);
+extern int cmd_write_raw(int argc, const char **argv, const char *prefix);
 
 #endif
diff --git a/git.c b/git.c
index 37b1d76..f03be1a 100644
--- a/git.c
+++ b/git.c
@@ -357,6 +357,7 @@ static void handle_internal_command(int argc, const char **argv)
 		{ "verify-pack", cmd_verify_pack },
 		{ "show-ref", cmd_show_ref, RUN_SETUP },
 		{ "pack-refs", cmd_pack_refs, RUN_SETUP },
+		{ "write-raw", cmd_write_raw, RUN_SETUP },
 	};
 	int i;
 	static const char ext[] = STRIP_EXTENSION;
-- 
1.6.0.1

